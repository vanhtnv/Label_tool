<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Browser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .folder-item {
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .folder-item:hover {
            background-color: #f8f9fa;
        }
        .folder-item.active {
            background-color: #e9ecef;
        }
        .directory-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .breadcrumb-item a {
            text-decoration: none;
        }
        .breadcrumb-item.active {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h5 class="mb-3"><i class="fas fa-folder-open me-2"></i> Select Folder</h5>
        
        <!-- Breadcrumb navigation -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb" id="path-breadcrumb">
                <li class="breadcrumb-item"><a href="#" data-path="/">Root</a></li>
            </ol>
        </nav>
        
        <!-- Quick access -->
        <div class="mb-3">
            <label class="form-label">Quick Access</label>
            <div class="d-flex flex-wrap" id="quick-access">
                <button class="btn btn-sm btn-outline-secondary me-2 mb-2" data-path="/">
                    <i class="fas fa-home me-1"></i> Root
                </button>
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Directory list -->
        <div class="directory-list p-2 mb-3" id="directory-list">
            <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading directories...</p>
            </div>
        </div>
        
        <!-- Selected path -->
        <div class="mb-3">
            <label for="selected-path" class="form-label">Selected Path</label>
            <div class="input-group">
                <input type="text" class="form-control" id="selected-path" value="{{ start_path }}" readonly>
                <button class="btn btn-outline-secondary" type="button" id="copy-path-btn">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-secondary me-2" id="cancel-btn">Cancel</button>
            <button type="button" class="btn btn-primary" id="select-btn">Select Folder</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements with null checks
            const directoryList = document.getElementById('directory-list');
            const pathBreadcrumb = document.getElementById('path-breadcrumb');
            const selectedPath = document.getElementById('selected-path');
            const selectBtn = document.getElementById('select-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const copyPathBtn = document.getElementById('copy-path-btn');
            const quickAccess = document.getElementById('quick-access');
            
            // Check if required elements exist
            if (!directoryList) console.error('Element #directory-list not found');
            if (!pathBreadcrumb) console.error('Element #path-breadcrumb not found');
            if (!selectedPath) console.error('Element #selected-path not found');
            if (!quickAccess) console.error('Element #quick-access not found');
            
            let currentPath = '{{ start_path }}';
            const dialogId = '{{ dialog_id }}';
            
            // Load root directories for quick access
            fetch('/get_root_directories')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading root directories:', data.error);
                        return;
                    }
                    
                    // Clear default buttons and add new ones
                    if (!quickAccess) {
                        console.error('quickAccess element is not available');
                        return;
                    }
                    
                    quickAccess.innerHTML = '';
                    
                    data.directories.forEach(dir => {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-sm btn-outline-secondary me-2 mb-2';
                        btn.setAttribute('data-path', dir.path);
                        btn.innerHTML = `<i class="fas fa-folder me-1"></i> ${dir.name}`;
                        
                        btn.addEventListener('click', function() {
                            loadDirectory(dir.path);
                        });
                        
                        quickAccess.appendChild(btn);
                    });
                })
                .catch(error => {
                    console.error('Error loading root directories:', error);
                    if (quickAccess) {
                        quickAccess.innerHTML = `
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-circle me-2"></i> Error loading directories
                            </div>
                        `;
                    }
                });
            
            // Load the initial directory with error handling
            try {
                loadDirectory(currentPath);
            } catch (error) {
                console.error('Error loading initial directory:', error);
                if (directoryList) {
                    directoryList.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i> Error loading directory: ${error.message || 'Unknown error'}
                        </div>
                    `;
                }
            }
            
            // Load a directory
            function loadDirectory(path) {
                if (!directoryList) {
                    console.error('directoryList element not found');
                    return;
                }
                
                directoryList.innerHTML = `
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading directories...</p>
                    </div>
                `;
                
                fetch('/get_directories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `base_path=${encodeURIComponent(path)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        if (directoryList) {
                            directoryList.innerHTML = `
                                <div class="alert alert-danger" role="alert">
                                    <i class="fas fa-exclamation-circle me-2"></i> ${data.error}
                                </div>
                            `;
                        }
                        return;
                    }
                    
                    // Update current path
                    currentPath = data.base_path;
                    if (selectedPath) {
                        selectedPath.value = currentPath;
                    }
                    
                    // Update breadcrumbs
                    try {
                        updateBreadcrumbs(currentPath);
                    } catch (error) {
                        console.error('Error updating breadcrumbs:', error);
                    }
                    
                    // Clear the directory list
                    if (directoryList) {
                        directoryList.innerHTML = '';
                    }
                    
                    if (data.directories.length === 0) {
                        if (directoryList) {
                            directoryList.innerHTML = `
                                <div class="alert alert-info" role="alert">
                                    <i class="fas fa-info-circle me-2"></i> No subdirectories found
                                </div>
                            `;
                        }
                        return;
                    }
                    
                    // Add parent directory if not at root
                    if (currentPath !== '/' && directoryList) {
                        const parentItem = document.createElement('div');
                        parentItem.className = 'folder-item';
                        parentItem.innerHTML = `
                            <i class="fas fa-arrow-up me-2"></i> ..
                        `;
                        
                        parentItem.addEventListener('click', function() {
                            const parentPath = currentPath.split('/').slice(0, -1).join('/') || '/';
                            loadDirectory(parentPath);
                        });
                        
                        directoryList.appendChild(parentItem);
                    }
                    
                    // Add directories
                    if (directoryList) {
                        data.directories.forEach(dir => {
                            const dirItem = document.createElement('div');
                            dirItem.className = 'folder-item';
                            dirItem.innerHTML = `
                                <i class="fas fa-folder me-2"></i> ${dir.name}
                            `;
                            
                            dirItem.addEventListener('click', function() {
                                loadDirectory(dir.path);
                            });
                            
                            directoryList.appendChild(dirItem);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading directory:', error);
                    if (directoryList) {
                        directoryList.innerHTML = `
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-circle me-2"></i> Error loading directory: ${error.message || 'Unknown error'}
                            </div>
                        `;
                    }
                });
            }
            
            // Update breadcrumbs
            function updateBreadcrumbs(path) {
                // Safety check for pathBreadcrumb
                if (!pathBreadcrumb) {
                    console.error('pathBreadcrumb element not found');
                    return;
                }

                // Clear existing breadcrumbs except the root
                while (pathBreadcrumb.children && pathBreadcrumb.children.length > 1 && pathBreadcrumb.lastChild) {
                    pathBreadcrumb.removeChild(pathBreadcrumb.lastChild);
                }
                
                // If we're at root, mark it as active
                if (path === '/') {
                    if (pathBreadcrumb.firstChild) {
                        pathBreadcrumb.firstChild.classList.add('active');
                        pathBreadcrumb.firstChild.removeAttribute('href');
                    }
                    return;
                }
                
                // Make sure root is not active and has a link
                if (pathBreadcrumb.firstChild) {
                    pathBreadcrumb.firstChild.classList.remove('active');
                    pathBreadcrumb.firstChild.innerHTML = '<a href="#" data-path="/">Root</a>';
                }
                
                // Add path segments
                const segments = path.split('/').filter(Boolean);
                let currentSegmentPath = '';
                
                segments.forEach((segment, index) => {
                    currentSegmentPath += '/' + segment;
                    
                    const breadcrumbItem = document.createElement('li');
                    breadcrumbItem.className = 'breadcrumb-item';
                    
                    if (index === segments.length - 1) {
                        // Last segment (current directory)
                        breadcrumbItem.classList.add('active');
                        breadcrumbItem.textContent = segment;
                    } else {
                        // Intermediate segment
                        breadcrumbItem.innerHTML = `<a href="#" data-path="${currentSegmentPath}">${segment}</a>`;
                    }
                    
                    if (pathBreadcrumb) {
                        pathBreadcrumb.appendChild(breadcrumbItem);
                    }
                });
                
                // Add click handlers to breadcrumb links
                try {
                    document.querySelectorAll('#path-breadcrumb a').forEach(link => {
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            const path = this.getAttribute('data-path');
                            loadDirectory(path);
                        });
                    });
                } catch (error) {
                    console.error('Error adding click handlers to breadcrumbs:', error);
                }
            }
            
            // Select button handler
            if (selectBtn) {
                selectBtn.addEventListener('click', function() {
                    try {
                        // Send message to parent window with selected path
                        if (window.opener) {
                            window.opener.postMessage({
                                type: 'folderSelected',
                                dialogId: dialogId,
                                path: currentPath
                            }, '*');
                        } else {
                            console.error('No parent window found');
                        }
                        
                        // Close the dialog
                        window.close();
                    } catch (error) {
                        console.error('Error in select button handler:', error);
                    }
                });
            }
            
            // Cancel button handler
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    window.close();
                });
            }
            
            // Copy path button handler
            if (copyPathBtn && selectedPath) {
                copyPathBtn.addEventListener('click', function() {
                    try {
                        selectedPath.select();
                        document.execCommand('copy');
                        
                        // Visual feedback
                        copyPathBtn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            copyPathBtn.innerHTML = '<i class="fas fa-copy"></i>';
                        }, 1500);
                    } catch (error) {
                        console.error('Error copying to clipboard:', error);
                    }
                });
            }
        });
    </script>
</body>
</html>
